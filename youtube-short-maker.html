<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Auto-Cut Clip Maker — Scene + Silence Detection</title>
<style>
body{font-family:system-ui,Arial;margin:14px;color:#111}
h1{margin:0 0 6px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.panel{border:1px solid #ddd;padding:12px;border-radius:8px;min-width:320px;flex:1}
label{display:block;margin:8px 0 4px;font-weight:600}
input[type=file],textarea,input[type=number]{padding:6px;width:100%;}
button{padding:8px 12px;border-radius:8px;border:0;background:#0b76ff;color:#fff;cursor:pointer}
button.secondary{background:#666}
canvas{background:#000;display:block;margin:8px 0;max-width:100%}
#log{white-space:pre-wrap;font-family:monospace;margin-top:8px;background:#f8f8f8;padding:8px;border-radius:6px}
.small{font-size:13px;color:#555}
.clips{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.clip-item{padding:8px;border:1px dashed #ccc;border-radius:6px;display:flex;gap:8px;align-items:center;justify-content:space-between}
.meta{font-size:13px;color:#333}
</style>
</head>
<body>
<h1>Auto-Cut Clip Maker — Scene + Silence</h1>
<div class="small">Upload a video → Auto-cut using scene changes + silence → Preview → Export clips (WebM)</div>

<div class="row" style="margin-top:12px">
  <div class="panel">
    <label>1) Upload video</label>
    <input id="file" type="file" accept="video/*">
    <div id="video-info" class="small" style="margin-top:8px"></div>

    <label>2) Settings</label>
    <div class="small">Frame sample interval (ms)</div>
    <input id="sampleMs" type="number" value="250" min="50" step="50">
    <div class="small">Frame difference threshold (0-1)</div>
    <input id="threshold" type="number" value="0.18" min="0.01" max="1" step="0.01">
    <div class="small">Silence threshold (0-1 RMS)</div>
    <input id="silenceThresh" type="number" value="0.02" min="0.001" max="0.1" step="0.001">
    <div class="small">Min silence duration (s)</div>
    <input id="minSilence" type="number" value="0.5" min="0.1" step="0.1">

    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="scanBtn">Scan & Detect Cuts</button>
      <button id="autoTrimBtn" class="secondary">Auto Trim Fixed Clips</button>
    </div>

    <label style="margin-top:12px">Optional captions</label>
    <textarea id="captions" placeholder="Optional text for all clips" style="min-height:60px"></textarea>

    <div style="margin-top:10px">
      <button id="exportAll" class="secondary">Export All Detected Clips</button>
    </div>
  </div>

  <div class="panel">
    <label>Preview</label>
    <canvas id="previewCanvas" width="720" height="405"></canvas>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <button id="playPreview">Play</button>
      <button id="pausePreview" class="secondary">Pause</button>
      <div id="currentTime" class="small" style="margin-left:8px"></div>
    </div>

    <label style="margin-top:12px">Detected clips</label>
    <div id="clips" class="clips"></div>
    <div id="log"></div>
  </div>
</div>

<video id="sourceVideo" playsinline style="display:none"></video>

<script>
const fileInput=document.getElementById('file');
const video=document.getElementById('sourceVideo');
const info=document.getElementById('video-info');
const scanBtn=document.getElementById('scanBtn');
const sampleMsEl=document.getElementById('sampleMs');
const thresholdEl=document.getElementById('threshold');
const silenceThreshEl=document.getElementById('silenceThresh');
const minSilenceEl=document.getElementById('minSilence');
const previewCanvas=document.getElementById('previewCanvas');
const ctx=previewCanvas.getContext('2d');
const clipsContainer=document.getElementById('clips');
const captionsInput=document.getElementById('captions');
const autoTrimBtn=document.getElementById('autoTrimBtn');
const exportAllBtn=document.getElementById('exportAll');
const playBtn=document.getElementById('playPreview');
const pauseBtn=document.getElementById('pausePreview');
const currentTimeEl=document.getElementById('currentTime');
const logEl=document.getElementById('log');

let fileURL=null,videoReady=false,detections=[],clipRanges=[],sampling=false;

function log(...a){ logEl.textContent=a.join(' ') }

fileInput.addEventListener('change', e=>{
  if(fileURL) URL.revokeObjectURL(fileURL);
  const f=e.target.files[0];
  if(!f) return;
  fileURL=URL.createObjectURL(f);
  video.src=fileURL; video.load(); videoReady=false;
  info.textContent=`Loaded: ${f.name} (${Math.round(f.size/1024)} KB)`;
  detections=[]; clipRanges=[]; renderClipsUI();
  log('Video loaded. Wait for metadata.');
});

video.addEventListener('loadedmetadata', ()=>{
  videoReady=true;
  previewCanvas.width=Math.min(960,video.videoWidth);
  previewCanvas.height=Math.round(previewCanvas.width*9/16);
  info.textContent+=` — ${video.videoWidth}x${video.videoHeight}, ${video.duration.toFixed(2)}s`;
  log('Metadata ready. Ready to scan.');
});

// frame-diff helpers
function getFrameGray(w=64,h=36){
  const off=document.createElement('canvas'); off.width=w; off.height=h;
  const g=off.getContext('2d');
  try{ g.drawImage(video,0,0,video.videoWidth,video.videoHeight,0,0,w,h); }
  catch(e){ return null; }
  const data=g.getImageData(0,0,w,h).data;
  const gray=new Float32Array(w*h);
  for(let i=0;i<w*h;i++){
    const r=data[i*4],gg=data[i*4+1],b=data[i*4+2];
    gray[i]=(0.299*r+0.587*gg+0.114*b)/255;
  }
  return {w,h,gray};
}
function diffFrames(a,b){ if(!a||!b) return 1; const n=a.gray.length; let s=0; for(let i=0;i<n;i++) s+=Math.abs(a.gray[i]-b.gray[i]); return s/n; }
function seekTo(t){ return new Promise(res=>{ const onSeek=()=>{video.removeEventListener('seeked',onSeek); res();}; video.addEventListener('seeked',onSeek); try{video.currentTime=Math.min(video.duration,Math.max(0,t));}catch(e){setTimeout(res,120);} setTimeout(()=>{video.removeEventListener('seeked',onSeek); res();},400);}); }

// silence detection
async function detectSilence(audioBuffer,threshold=0.02,minDur=0.5){
  const data=audioBuffer.getChannelData(0);
  const sampleRate=audioBuffer.sampleRate;
  const minSamples=minDur*sampleRate;
  let silences=[];
  let start=null;
  for(let i=0;i<data.length;i++){
    const rms=Math.abs(data[i]);
    if(rms<threshold){
      if(start===null) start=i;
    }else{
      if(start!==null && (i-start)>=minSamples) silences.push({start:start/sampleRate,end:i/sampleRate});
      start=null;
    }
  }
  if(start!==null && (data.length-start)>=minSamples) silences.push({start:start/sampleRate,end:data.length/sampleRate});
  return silences;
}

scanBtn.addEventListener('click',async ()=>{
  if(!videoReady){ log('Load a video first'); return; }
  detections=[]; clipRanges=[]; renderClipsUI();
  const sampleMs=Number(sampleMsEl.value)||250;
  const threshold=Number(thresholdEl.value)||0.18;
  const silenceThresh=Number(silenceThreshEl.value)||0.02;
  const minSilence=Number(minSilenceEl.value)||0.5;
  log(`Scanning frames & audio. SampleMs=${sampleMs}, threshold=${threshold}, silence=${silenceThresh}, minSilence=${minSilence}`);

  // video frame detection
  sampling=true;
  video.pause(); 
  const dur=video.duration;
  const samples=Math.max(3,Math.floor((dur*1000)/sampleMs));
  let prevFrame=null;
  for(let i=0;i<=samples && sampling;i++){
    const t=Math.min(dur,(i*sampleMs)/1000);
    await seekTo(t); await new Promise(r=>setTimeout(r,30));
    const frame=getFrameGray(64,36);
    const d=diffFrames(frame,prevFrame);
    if(prevFrame && d>threshold) detections.push(t);
    prevFrame=frame;
    if(i%Math.max(1,Math.floor(samples/20))===0) log(`Scanning ${Math.round((i/samples)*100)}% — t=${t.toFixed(2)}s — diff=${d.toFixed(3)}`);
  }
  sampling=false;

  // audio silence detection
  const ctxAudio=new (window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,video.duration*44100,44100);
  const source=ctxAudio.createBufferSource();
  const file=await fetch(fileURL).then(r=>r.arrayBuffer());
  const audioBuf=await ctxAudio.decodeAudioData(file);
  source.buffer=audioBuf; source.connect(ctxAudio.destination); source.start(0);
  const rendered=await ctxAudio.startRendering();
  const silences=await detectSilence(rendered,silenceThresh,minSilence);

  // combine scene cuts + silences
  const cutTimes=[...detections,...silences.map(s=>s.start)];
  cutTimes.sort((a,b)=>a-b);
  const pts=[0,...cutTimes.filter(t=>t>0 && t<dur),dur];
  clipRanges=[];
  for(let i=0;i<pts.length-1;i++) clipRanges.push({start:pts[i],end:pts[i+1]});
  renderClipsUI();
  log(`Scan complete: ${clipRanges.length} clips detected (scene+silence).`);
});

function renderClipsUI(){
  clipsContainer.innerHTML='';
  if(clipRanges.length===0){ clipsContainer.textContent='No clips yet.'; return; }
  clipRanges.forEach((r,idx)=>{
    const el=document.createElement('div'); el.className='clip-item';
    const left=document.createElement('div'); left.className='meta';
    left.innerHTML=`Clip ${idx+1} — ${r.start.toFixed(2)}s → ${r.end.toFixed(2)}s (${(r.end-r.start).toFixed(2)}s)`;
    const right=document.createElement('div');
    const btnPreview=document.createElement('button'); btnPreview.textContent='Preview'; btnPreview.onclick=()=>previewRange(r.start,r.end);
    const btnExport=document.createElement('button'); btnExport.textContent='Export'; btnExport.style.marginLeft='8px';
    btnExport.onclick=()=>exportRange(r.start,r.end,idx+1);
    right.appendChild(btnPreview); right.appendChild(btnExport);
    el.appendChild(left); el.appendChild(right);
    clipsContainer.appendChild(el);
  });
}

// Preview & export functions same as previous code
// ... you can reuse previewRange() & exportRange() from previous code

playBtn.addEventListener('click',()=>{video.muted=true; video.play().catch(()=>{});});
pauseBtn.addEventListener('click',()=>{video.pause();});
autoTrimBtn.addEventListener('click',()=>{
  if(!videoReady){ log('Load video first'); return; }
  const maxLen=60; clipRanges=[]; const dur=video.duration;
  for(let s=0;s<dur;s+=maxLen) clipRanges.push({start:s,end:Math.min(dur,s+maxLen)});
  renderClipsUI();
  log('Auto-trim into '+clipRanges.length+' clips of up to '+maxLen+'s');
});
</script>
</body>
</html>
